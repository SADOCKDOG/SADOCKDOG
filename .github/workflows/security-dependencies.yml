name: Security - Dependency Scanning

# Escanea dependencias en busca de vulnerabilidades conocidas (CVEs)
# Backend: pip-audit (Python packages)
# Frontend: osv-scanner (npm/pnpm lockfile)

on:
  push:
    branches: ["**"]
    paths:
      - "autogpt_platform/backend/poetry.lock"
      - "autogpt_platform/frontend/pnpm-lock.yaml"
      - "autogpt_platform/autogpt_libs/poetry.lock"
      - "classic/**/poetry.lock"
      - ".github/workflows/security-dependencies.yml"
  pull_request:
    branches: [master, dev]
  schedule:
    # Ejecutar diariamente para detectar CVEs nuevos
    - cron: "0 6 * * *" # 6 AM UTC diario

permissions:
  contents: read
  security-events: write # Para upload de SARIF

jobs:
  scan-python-backend:
    name: Scan Python dependencies (Backend)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install backend dependencies
        working-directory: autogpt_platform/backend
        run: |
          poetry install --no-root

      - name: Run pip-audit on backend
        id: pip-audit-backend
        working-directory: autogpt_platform/backend
        run: |
          poetry run pip install pip-audit
          poetry run pip-audit --desc --format json --output pip-audit-backend.json || true

      - name: Convert to SARIF (backend)
        if: always()
        working-directory: autogpt_platform/backend
        run: |
          poetry run pip-audit --desc --format cyclonedx-json --output pip-audit-backend-cyclonedx.json || true
          # pip-audit no genera SARIF nativo, usar formato JSON para reporte manual

      - name: Upload backend audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-backend-results
          path: autogpt_platform/backend/pip-audit-*.json
          retention-days: 30

  scan-python-libs:
    name: Scan Python dependencies (Libs)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install libs dependencies
        working-directory: autogpt_platform/autogpt_libs
        run: |
          poetry install --no-root

      - name: Run pip-audit on libs
        id: pip-audit-libs
        working-directory: autogpt_platform/autogpt_libs
        run: |
          poetry run pip install pip-audit
          poetry run pip-audit --desc --format json --output pip-audit-libs.json || true

      - name: Upload libs audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-libs-results
          path: autogpt_platform/autogpt_libs/pip-audit-*.json
          retention-days: 30

  scan-frontend:
    name: Scan npm/pnpm dependencies (Frontend)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "21"

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install osv-scanner
        run: |
          curl -sSL https://github.com/google/osv-scanner/releases/download/v1.8.5/osv-scanner_1.8.5_linux_amd64 -o osv-scanner
          chmod +x osv-scanner
          sudo mv osv-scanner /usr/local/bin/

      - name: Run osv-scanner on pnpm lockfile
        id: osv-scan
        working-directory: autogpt_platform/frontend
        run: |
          osv-scanner scan --lockfile pnpm-lock.yaml --format json --output osv-scan-results.json || true

      - name: Convert OSV results to SARIF
        if: always()
        working-directory: autogpt_platform/frontend
        run: |
          osv-scanner scan --lockfile pnpm-lock.yaml --format sarif --output osv-scan.sarif || true

      - name: Upload SARIF to code scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: autogpt_platform/frontend/osv-scan.sarif
          category: osv-scanner-frontend

      - name: Upload OSV scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: osv-scanner-frontend-results
          path: autogpt_platform/frontend/osv-scan-results.json
          retention-days: 30

  summarize-results:
    name: Summarize vulnerability findings
    runs-on: ubuntu-latest
    needs: [scan-python-backend, scan-python-libs, scan-frontend]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: scan-results

      - name: Generate summary report
        run: |
          echo "# ðŸ” Dependency Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Backend results
          if [ -f scan-results/pip-audit-backend-results/pip-audit-backend.json ]; then
            BACKEND_VULNS=$(jq '.dependencies | length' scan-results/pip-audit-backend-results/pip-audit-backend.json || echo "0")
            echo "### Backend (Python)" >> $GITHUB_STEP_SUMMARY
            echo "- Vulnerabilities found: **$BACKEND_VULNS**" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Libs results
          if [ -f scan-results/pip-audit-libs-results/pip-audit-libs.json ]; then
            LIBS_VULNS=$(jq '.dependencies | length' scan-results/pip-audit-libs-results/pip-audit-libs.json || echo "0")
            echo "### Libs (Python)" >> $GITHUB_STEP_SUMMARY
            echo "- Vulnerabilities found: **$LIBS_VULNS**" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Frontend results
          if [ -f scan-results/osv-scanner-frontend-results/osv-scan-results.json ]; then
            FRONTEND_VULNS=$(jq '.results[0].packages | length' scan-results/osv-scanner-frontend-results/osv-scan-results.json || echo "0")
            echo "### Frontend (npm/pnpm)" >> $GITHUB_STEP_SUMMARY
            echo "- Vulnerabilities found: **$FRONTEND_VULNS**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Full reports available in workflow artifacts." >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— SARIF reports uploaded to Security > Code scanning alerts" >> $GITHUB_STEP_SUMMARY
