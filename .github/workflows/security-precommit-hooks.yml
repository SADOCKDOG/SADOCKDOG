name: Security - Pre-commit Hooks Validation

# Valida que los hooks de pre-commit funcionen correctamente
# Ejecuta mismo conjunto de validaciones que desarrolladores localmente

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [master, dev]
  schedule:
    # Ejecutar semanalmente para detectar regresiones
    - cron: "0 3 * * 1" # Lunes 3 AM UTC

permissions:
  contents: read

jobs:
  validate-hooks:
    name: Validate pre-commit hooks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para pre-push hooks

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Install Gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.19.3/gitleaks_8.19.3_linux_x64.tar.gz
          tar -xzf gitleaks_8.19.3_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
          gitleaks version

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: Run Gitleaks hooks only
        run: |
          # Solo ejecutar hooks de Gitleaks para validar configuración
          pre-commit run gitleaks --all-files --hook-stage pre-commit || true
          
      - name: Validate pre-commit config syntax
        run: |
          pre-commit validate-config .pre-commit-config.yaml

      - name: Test pre-commit installation
        run: |
          # Simular instalación de hooks
          pre-commit install --install-hooks
          pre-commit install --hook-type pre-push

  test-secret-detection:
    name: Test secret detection on sample files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.19.3/gitleaks_8.19.3_linux_x64.tar.gz
          tar -xzf gitleaks_8.19.3_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/

      - name: Test on .env.example files (should pass)
        run: |
          # .env.example debe estar en allowlist y pasar
          gitleaks detect --config .gitleaks.toml --verbose --no-git
          echo "✅ Allowlist funcionando: .env.example archivos permitidos"

      - name: Create test file with fake secret
        run: |
          mkdir -p /tmp/test-gitleaks
          echo 'API_KEY="sk-test-REAL_SECRET_12345678"' > /tmp/test-gitleaks/test.py

      - name: Test detection on fake secret (should fail)
        id: test-detection
        continue-on-error: true
        run: |
          cd /tmp/test-gitleaks
          gitleaks detect --config $GITHUB_WORKSPACE/.gitleaks.toml --no-git --verbose

      - name: Verify detection worked
        if: steps.test-detection.outcome == 'success'
        run: |
          echo "❌ ERROR: Gitleaks debería haber detectado el secreto de prueba"
          exit 1

      - name: Confirm detection
        if: steps.test-detection.outcome == 'failure'
        run: |
          echo "✅ Detección funcionando: secreto de prueba detectado correctamente"
